<html>
<head>
  <style>
    .keyboard .key:not(.acc) {
      width: 23;
      height: 120;
      fill: white;
      stroke: black;
    }
    .keyboard .key.acc {
      width: 13;
      height: 80;
      fill: black;
      stroke: black;      
    }
    .keyboard .key.highlight {
      fill: teal !important;
    }
  </style>
</head>
<body style="text-align: center; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
  <div style="width: 800px; max-width: 100%; margin: 0 auto;">
    <svg class="keyboard" xml:space="preserve" viewBox="0 0 322 120" style="margin: 0 auto; width: 100%">
      <g octave="0">
        <rect class="key" nval="c3" x="0" y="0" />
        <rect class="key" nval="d3" x="23" y="0" />
        <rect class="key" nval="e3" x="46" y="0" />
        <rect class="key" nval="f3" x="69" y="0" />
        <rect class="key" nval="g3" x="92" y="0" />
        <rect class="key" nval="a4" x="115" y="0" />
        <rect class="key" nval="b4" x="138" y="0" />
        <rect class="key acc" nval="c-3" x="14.33333" y="0" />
        <rect class="key acc" nval="d-3" x="41.66666" y="0" />
        <rect class="key acc" nval="f-3" x="82.25" y="0" />
        <rect class="key acc" nval="g-3" x="108.25" y="0" />
        <rect class="key acc" nval="a-4" x="134.75" y="0" />
      </g>
      <g octave="1" transform="translate(161, 0)">
        <rect class="key" nval="c4" x="0" y="0" />
        <rect class="key" nval="d4" x="23" y="0" />
        <rect class="key" nval="e4" x="46" y="0" />
        <rect class="key" nval="f4" x="69" y="0" />
        <rect class="key" nval="g4" x="92" y="0" />
        <rect class="key" nval="a5" x="115" y="0" />
        <rect class="key" nval="b5" x="138" y="0" />
        <rect class="key acc" nval="c-4" x="14.33333" y="0" />
        <rect class="key acc" nval="d-4" x="41.66666" y="0" />
        <rect class="key acc" nval="f-4" x="82.25" y="0" />
        <rect class="key acc" nval="g-4" x="108.25" y="0" />
        <rect class="key acc" nval="a-5" x="134.75" y="0" />
      </g>
    </svg>
    <div style="margin: 1rem 0 0.75rem; background-color: whitesmoke; width: auto;">
      <div class="chord-name" style="font-weight: bold; font-size: 3rem; color: teal; padding: 1rem;">
        --
      </div>
      <div class="countdown animate" style="width: 100%; height: 0.25rem; background-color: teal;"></div>
    </div>
    <div style="margin: 1rem 0 0.75rem; display: flex; gap: 1rem;">
      <div style="display: flex; flex-direction: column; gap: 1rem; flex-grow: 1;">
        <button style="border: none; background-color: whitesmoke; padding: 1rem; cursor: pointer;  font-weight: bold;" onclick="loadChords(triads_in_c)">Major &amp; Minor in Key of C</button>
        <button style="border: none; background-color: whitesmoke; padding: 1rem;  cursor: pointer;  font-weight: bold;" onclick="loadChords(triads)">All Major &amp; Minor</button>
        <button style="border: none; background-color: whitesmoke; padding: 1rem;  cursor: pointer;  font-weight: bold;" onclick="loadChords(triads_and_sevenths)">Major, Minor &amp; 7ths</button>
      </div>
      <div style="flex-grow: 1">
        <textarea autofocus class="chordset" style="width: 100%; height: 100%; border: none; background-color: whitesmoke; padding: 1rem; font-family: monospace; font-size: 14px;" 
        placeholder="Enter chords here seperated by commas (no spaces), or click one of the chord sets on the left. Set the time given per chord below, along with speed increase per chord."></textarea>
      </div>
    </div>
    <div style="display: flex; text-transform: uppercase; font-size: 0.75rem; text-align: left; gap: 1rem">
      <label style="flex-grow: 1;">
        <div>
          Time
        </div>
        <input class="time" type="text" value="5" style="margin-top: 0.25rem; border: none; padding: 1rem; background-color: whitesmoke; width: 100%">
      </label>
      <label style="flex-grow: 1;">
        <div>
          Speedup
        </div>
        <input class="speedup" type="text" value="0.01" style="margin-top: 0.25rem; border: none; padding: 1rem; background-color: whitesmoke; width: 100%">
      </label>
    </div>    
    <button class="start" onclick="start()" style="margin-top: 1rem; font-size: 2rem; padding: 0.75rem; background-color: teal; color: white; border: none; width: 100%; font-weight: bold; cursor: pointer">
      START
    </button>  
  </div>
  <script>
    var note_names = ["A", "A#", "Bb", "B", "C", "C#", "Db", "D", "D#", "Eb", "E", "F", "F#", "Gb", "G", "G#", "Ab"];
    var triads_in_c = ["C", "Dm", "Em", "F", "G", "Am"];
    let extension_map = {
      "": [0, 4, 7],
      "m": [0, 3, 7],
      "m7": [0, 3, 7, 10],
      "7": [0, 4, 7, 10],
      "maj7": [0, 4, 7, 11],
    }
    var triads = note_names.concat(note_names.map(note => note + "m"));
    var triads_and_sevenths = triads.concat(note_names.map(note => note + "7"), note_names.map(note => note + "maj7"), note_names.map(note => note + "m7"));
    var keyboard_keys = note_names
      .filter(note => !note.endsWith("b"))
      .map(note => note.toLowerCase().replace("#", "-"));
    let shifted_keys = keyboard_keys.splice(0, 3);
    keyboard_keys = keyboard_keys.concat(shifted_keys);
    keyboard_keys = keyboard_keys.map(
      key => key + (key.startsWith("a") || key.startsWith("b") ? 4 : 3)).concat(keyboard_keys.map(
      key => key + (key.startsWith("a") || key.startsWith("b") ? 5 : 4)));
    let audio_files = keyboard_keys.map(key => new Audio(`/audio/${key}.mp3`))

    var note_values = {};
    var [last_note, last_value] = [null, 0];
    for (let note of note_names) {
      var new_value = last_value
      if (last_note != null && (note.length == 1 || last_note.length == 1)) {
        new_value += 1;
      }
      note_values[note] = new_value
      last_note = note;
      last_value = new_value;
    }
    var getChordKeys = (chord_name) => {
      let root = note_names
        .filter(note => chord_name.startsWith(note))
        .reduce((a, b) => a.length > b.length ? a : b);
      let root_value = note_values[root];
      let extension = chord_name.substring(root.length);
      console.log(root_value, extension)
      let extension_values = extension_map[extension];
      let chord_vals = extension_values.map(delta => (root_value + delta) % 12);
      let chord_w_octaves = [];
      let [prev_adjusted_val, prev_octave] = [-1, 0]
      for (let val of chord_vals) {
        let adjusted_val = (val + 9) % 12; 
        let octave = adjusted_val > prev_adjusted_val ? prev_octave : prev_octave + 1;
        chord_w_octaves.push(keyboard_keys[adjusted_val + 12 * octave])
        prev_adjusted_val = adjusted_val;
        prev_octave = octave;
      }
      return chord_w_octaves;
    }
    var clearHighlights = () => {
      document.querySelectorAll(`.key.highlight`).forEach(
        key => key.classList.remove("highlight")
      );
    }
    var highlightChord = (chord_name) => {
      clearHighlights();
      let chord_keys = getChordKeys(chord_name);
      for (let key of chord_keys) {
        document.querySelector(`.keyboard .key[nval="${key}"]`).classList.add("highlight");
      }
    } 
    var playChord = (chord_name) => {
      let chord_keys = getChordKeys(chord_name);
      for (let key of chord_keys) {
        let audio = audio_files[keyboard_keys.indexOf(key)];
        audio.play();
      }
    }

    var loadChords = (chords) => {
      document.querySelector(".chordset").value = chords.join(",");
    }    
    var state = "STOPPED";
    var chordset = [];
    var timeout = null;
    var start = () => {
      if (state == "STOPPED") {
        var time = parseFloat(document.querySelector(".time").value)
        var speedup = parseFloat(document.querySelector(".speedup").value)
        chordset = document.querySelector(".chordset").value.split(",");
        if (chordset.length === 1 && chordset[0] === "") {
          alert("Enter chords.")
          return;
        }
        startIteration(time, speedup);
        document.querySelector(".start").innerHTML = "STOP";
        state = "STARTED";
      } else {
        document.querySelector(".start").innerHTML = "START";
        stopIteration();
        state = "STOPPED";
      }
    }
    var startIteration = (time, speedup, previous_chord) => {
      clearHighlights();
      var selected_chord_index = Math.floor(chordset.length * Math.random());
      var selected_chord = chordset[selected_chord_index];
      if (selected_chord === previous_chord) {
        selected_chord = chordset[(selected_chord_index + chordset.length - 1) % chordset.length];
      }
      document.querySelector(".chord-name").innerHTML = selected_chord;
      document.querySelector(".countdown").style.transition = `width ${time}s linear`;
      document.querySelector(".countdown").style.visibility = `visible`;
      document.querySelector(".countdown").style.width = "0%";
      timeout = window.setTimeout(endInteration.bind(null, time, speedup, selected_chord), time * 1000);
    }
    var endInteration = (time, speedup, selected_chord) => {
      document.querySelector(".countdown").style.transition = `none`;
      document.querySelector(".countdown").style.width = "100%";
      document.querySelector(".countdown").style.visibility = `hidden`;
      highlightChord(selected_chord);
      playChord(selected_chord);
      time = Math.max(time - speedup, 1);
      timeout = window.setTimeout(startIteration.bind(null, time, speedup, selected_chord), 2500);
    }
    var stopIteration = () => {
      window.clearTimeout(timeout);
      clearHighlights();
      document.querySelector(".countdown").style.transition = `none`;
      document.querySelector(".countdown").style.width = "100%";
      document.querySelector(".countdown").style.visibility = `visible`;
      document.querySelector(".chord-name").innerHTML = "--";
    }

  </script>
</body>

</html>